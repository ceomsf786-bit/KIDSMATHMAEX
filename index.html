<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dynamic Math Quiz (Numeric Keypad + Timestamp)</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;}
.container{max-width:900px;margin:0 auto;background:white;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.25);overflow:hidden;}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:28px;text-align:center;}
.timer-display{background:rgba(255,255,255,0.15);padding:12px 18px;border-radius:10px;margin-top:12px;font-size:20px;font-weight:700;letter-spacing:1px;display:inline-block;}
.content{padding:28px;}
.quiz-selector,.name-input-section,.question-container{margin-bottom:24px;padding:18px;background:#f8f9fa;border-radius:12px;border-left:5px solid #667eea;}
.quiz-selector label,.name-input-section label{font-weight:700;margin-bottom:8px;display:block;color:#2d3748;font-size:16px;}
.quiz-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:10px;}
.quiz-btn{padding:10px 12px;background:white;border:2px solid #667eea;border-radius:10px;cursor:pointer;transition:0.2s;font-size:15px;font-weight:700;color:#667eea;text-align:center;}
.quiz-btn:hover{background:#667eea;color:white;transform:translateY(-3px);box-shadow:0 6px 14px rgba(102,126,234,0.25);}
.quiz-btn.active{background:#667eea;color:white;}
.name-input-section input{width:100%;padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;}
.name-input-section input:focus{outline:none;border-color:#667eea;}
.question-number{color:#667eea;font-weight:800;font-size:13px;margin-bottom:8px;}
.question{font-size:17px;font-weight:700;margin-bottom:12px;color:#2d3748;}
.exact-input{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;font-size:16px;}
.exact-input.correct{background:#d4edda;border-color:#28a745;}
.exact-input.incorrect{background:#f8d7da;border-color:#dc3545;}
.exact-answer-display{margin-top:10px;padding:10px 14px;background:#d4edda;border-left:4px solid #28a745;border-radius:8px;display:none;}
.exact-answer-display.show{display:block;}
.button-container{display:flex;gap:12px;margin-top:20px;flex-wrap:wrap;}
button{padding:12px 18px;font-size:15px;font-weight:700;border:none;border-radius:10px;cursor:pointer;transition:0.2s;flex:1;min-width:140px;}
.submit-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;}
.reset-btn{background:#6c757d;color:white;}
.copy-btn{background:#28a745;color:white;}
.results{margin-top:20px;padding:18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:12px;text-align:center;display:none;}
.results.show{display:block;}
.toast{position:fixed;top:18px;right:18px;background:#28a745;color:white;padding:12px 18px;border-radius:10px;display:none;}
.toast.show{display:block;}
</style>
</head>
<body>
<div class="toast" id="toast">Results copied to clipboard!</div>

<div class="container">
  <div class="header">
    <h1 id="quizTitle">Dynamic Math Quiz</h1>
    <div class="timer-display hidden" id="timerDisplay">‚è±Ô∏è 00:00:00</div>
  </div>

  <div class="content">
    <div class="quiz-selector" id="quizSelector">
      <label>Select Quiz Type:</label>
      <div class="quiz-buttons">
        <button class="quiz-btn" onclick="startQuiz('add')">Addition (+)</button>
        <button class="quiz-btn" onclick="startQuiz('subtract')">Subtraction (‚àí)</button>
        <button class="quiz-btn" onclick="startQuiz('multiply')">Multiplication (√ó)</button>
        <button class="quiz-btn" onclick="startQuiz('divide')">Division (√∑)</button>
        <button class="quiz-btn active" onclick="startQuiz('mixed')">Mixed</button>
      </div>
    </div>

    <div class="name-input-section" id="nameSection">
      <label for="studentName">Enter Your Name:</label>
      <input type="text" id="studentName" placeholder="Your full name" autocomplete="name">
    </div>

    <div id="quizForm"></div>

    <div class="button-container" id="actionButtons">
      <button type="button" class="submit-btn" onclick="handleSubmit()">Submit Quiz</button>
      <button type="button" class="reset-btn" onclick="resetQuiz()">Reset</button>
      <button type="button" class="copy-btn" id="copyBtn" onclick="copyResults()" disabled>Copy Results</button>
    </div>

    <div class="results" id="results">
      <h2>Quiz Results</h2>
      <div class="score" id="scoreDisplay"></div>
      <div class="feedback" id="feedback"></div>
      <div class="explanation" id="explanation"></div>
    </div>
  </div>
</div>

<script>
// ------------------------- CONFIG -------------------------
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyK53ZXPHkXNMTCTN8gs1LlM7D9JFCw2zzqL5ro0RnUv5iOwer6tdNUfR-DxX4JTr8/exec"; // <<-- REPLACE with your Apps Script Web App URL

// ------------------------- STATE -------------------------
let quizData = [];
let elapsedSeconds = 0;
let timerInterval = null;
let currentQuizType = "mixed";

// ------------------------- QUESTION GENERATION -------------------------
function generateRandomQuestions() {
  let types = currentQuizType === "mixed" ? ["add","subtract","multiply","divide"] : [currentQuizType];
  const questions = [];
  for (let i = 0; i < 20; i++) {
    const type = types[Math.floor(Math.random() * types.length)];
    const a = Math.floor(Math.random() * 12) + 1;
    const b = Math.floor(Math.random() * 12) + 1;
    let question, answer;
    if (type === "add") { question = `${a} + ${b} = ?`; answer = a + b; }
    else if (type === "subtract") { question = `${a} - ${b} = ?`; answer = a - b; }
    else if (type === "multiply") { question = `${a} √ó ${b} = ?`; answer = a * b; }
    else { const product = a * b; question = `${product} √∑ ${a} = ?`; answer = b; }
    questions.push({ question: question, exactAnswer: answer.toString() });
  }
  return questions;
}

// ------------------------- RENDER QUIZ -------------------------
function displayQuiz() {
  quizData = generateRandomQuestions();
  const quizForm = document.getElementById("quizForm");
  quizForm.innerHTML = "";
  quizData.forEach((q, i) => {
    quizForm.innerHTML += `
      <div class="question-container">
        <div class="question-number">Question ${i + 1}</div>
        <div class="question">${q.question}</div>
        <!-- numeric keypad with optional minus sign allowed -->
        <input type="text" inputmode="numeric" pattern="-?[0-9]*" class="exact-input" id="q${i}" placeholder="Enter number..." />
        <div class="exact-answer-display" id="q${i}_ans"></div>
      </div>`;
  });
  startTimer();
}

// ------------------------- TIMER -------------------------
function startTimer() {
  elapsedSeconds = 0;
  document.getElementById("timerDisplay").classList.remove("hidden");
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    elapsedSeconds++;
    const m = String(Math.floor(elapsedSeconds / 60)).padStart(2, "0");
    const s = String(elapsedSeconds % 60).padStart(2, "0");
    document.getElementById("timerDisplay").textContent = `‚è±Ô∏è 00:${m}:${s}`;
  }, 1000);
}
function stopTimer() { clearInterval(timerInterval); }

// ------------------------- HANDLE SUBMIT (UI + send) -------------------------
function handleSubmit() {
  const name = document.getElementById("studentName").value.trim();
  if (!name) return alert("Please enter your name!");

  stopTimer();
  let score = 0;

  // mark answers and show correct
  quizData.forEach((q, i) => {
    const input = document.getElementById(`q${i}`);
    const ansDiv = document.getElementById(`q${i}_ans`);
    const userAns = (input.value || "").trim();
    if (userAns === q.exactAnswer) {
      score++;
      input.classList.add("correct");
    } else {
      input.classList.add("incorrect");
    }
    ansDiv.textContent = "Correct Answer: " + q.exactAnswer;
    ansDiv.classList.add("show");
  });

  const pct = Math.round((score / quizData.length) * 100);
  document.getElementById("scoreDisplay").textContent = `${score}/${quizData.length} (${pct}%)`;
  document.getElementById("feedback").textContent = pct >= 80 ? "Excellent!" : pct >= 60 ? "Good!" : "Keep practising!";
  document.getElementById("explanation").innerHTML = `<strong>Name:</strong> ${name}<br><strong>Time:</strong> ${elapsedSeconds}s<br><strong>Mode:</strong> ${currentQuizType.toUpperCase()}`;
  document.getElementById("results").classList.add("show");
  document.getElementById("copyBtn").disabled = false;

  // prepare payload and send single POST
  submitQuizToSheet(name, quizData, elapsedSeconds, currentQuizType, score);
}

// ------------------------- BUILD & SEND payload -------------------------
function submitQuizToSheet(studentName, quizDataArr, elapsedSecondsVal, quizType, totalScore) {
  // Build answers array
  const answers = quizDataArr.map((q, i) => {
    const user = (document.getElementById(`q${i}`).value || "").trim() || "(no answer)";
    return {
      question: q.question,
      userAnswer: user,
      correctAnswer: q.exactAnswer,
      isCorrect: user === q.exactAnswer ? "YES" : "NO"
    };
  });

  const payload = {
    name: studentName,
    totalScore: totalScore,
    timestamp: new Date().toISOString(),
    answers: answers
  };

  // send ONE POST
  fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(response => {
    // optional: try to parse JSON response (Apps Script returns JSON)
    return response.text().then(txt => {
      try { return JSON.parse(txt); } catch(e) { return txt; }
    });
  })
  .then(resp => {
    console.log("Saved to sheet:", resp);
  })
  .catch(err => {
    console.error("Error saving to sheet:", err);
  });
}

// ------------------------- RESET, COPY, START -------------------------
function resetQuiz() {
  document.getElementById("results").classList.remove("show");
  document.getElementById("copyBtn").disabled = true;
  displayQuiz();
}

function copyResults() {
  const name = document.getElementById("studentName").value.trim();
  const now = new Date();
  const timestamp = now.toLocaleString();
  let resultText = `üìò Dynamic Math Quiz Results\nüóìÔ∏è Taken on: ${timestamp}\nüë§ Name: ${name}\nüéØ Mode: ${currentQuizType.toUpperCase()}\nüïí Time: ${elapsedSeconds}s\n\n`;
  quizData.forEach((q, i) => {
    const userAns = (document.getElementById(`q${i}`).value || "").trim() || "(no answer)";
    resultText += `Q${i+1}: ${q.question}\nYour Answer: ${userAns}\nCorrect Answer: ${q.exactAnswer}\n\n`;
  });
  const scoreText = document.getElementById("scoreDisplay").innerText;
  const feedback = document.getElementById("feedback").innerText;
  resultText += `Final Score: ${scoreText}\n${feedback}\n`;
  navigator.clipboard.writeText(resultText).then(() => {
    const toast = document.getElementById("toast");
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2000);
  });
}

function startQuiz(type) {
  currentQuizType = type;
  document.querySelectorAll(".quiz-btn").forEach(btn => btn.classList.remove("active"));
  // in some browsers, event may be undefined when called inline; use this fallback:
  try { event.target.classList.add("active"); } catch(e) {}
  displayQuiz();
}

// initial render
displayQuiz();
</script>
</body>
</html>
